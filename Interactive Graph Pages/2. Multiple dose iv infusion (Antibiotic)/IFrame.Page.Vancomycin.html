<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<script	src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
			  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
			  crossorigin="anonymous"/>
		 <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"/>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript" src="http://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.7.1/jstat.js"></script>
		<script type="text/javascript" src="http://requirejs.org/docs/release/2.2.0/minified/require.js"></script>	
		
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
			  rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
			  crossorigin="anonymous"/>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<style>
body {
    overflow: hidden;
    font-family: tahoma;
    font-weight: normal;
    background: #6ea4ca;
}

.container{
    margin-left: 10px;
    margin-top: 20px;
}
.chart-area{
    position: relative;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1; 
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

.custom_modal_header {
    height: 38px;
    background-color: #0c3c60;
    color: #fff!important;
}

.custom_modal_header_text {
    margin-top: 8px;
}

.custom_modal_content {
    margin-top: 10px;
    margin-bottom: 10px;
}

.custom_modal_footer {
    height: 30px;
    background-color: #0c3c60;
    color: #fff!important;
}

.custom_modal_footer_text {
    font-size: 13px;
    margin-top: 4px;
}

.w3-animate-opacity {
    animation: opac 0.8s;
}
    
@keyframes opac {
    0% {opacity: 0;}
    100% {opacity: 1;}
}
    
.w3-animate-show {
    animation: show 0.8s;
    animation-fill-mode: forwards;
}
    
@keyframes show {
    0% {opacity: 1;}
    100% {opacity: 0;}
}

.patient_data_table{
    width: 100%;
    margin-top: 10px;
    margin-right: 10px;
}

.patient_data_table tr:nth-child(1) {
    font-size: 14px;
    border-bottom: 2px solid #000000;
}	

.patient_data_table tr {
    font-size: 12px;
    border-bottom: 1px solid #000000;
}

.patient_data_table tr.not_header:hover {
    background: #dbddff;
}

.patient_data_table td label {
    display: inherit;
}

.patient_data_col {
    margin-right: 120px;
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;	
}

.watermark {
    color: #d0d0d0;
    font-size: 0.85em;
    position: relative;
    margin-top: -25px;
}

.table_title {
    font-size: 18px;
    font-family: Arial;
    font-weight: bold;
}
		</style>
		<title></title>
	</head>
	<body style="z-index: -1">
		<div class="row container" id="GraphContainer">
			<div class="col-lg-12">
				<h6> <br /></h6>
				<h6> <br /></h6>
				<div class="chart-area" style="position:relative" id="ChartArea">
					<div>
						<p class="watermark">	&copy; pharmacologytutorials.com</p>
					</div>
				</div>
			</div>
		</div>
		
		<!-- Modal Area -->
		<div id="SinglePatientData" class="w3-modal w3-animate-opacity">
			<div class="w3-modal-content w3-card-4">
				<header class="w3-container custom_modal_header">
					<span class="w3-button w3-middle w3-display-topright close" id="close_single">&times;</span>
					<h5 class="custom_modal_header_text">Single Patient Data</h5>
				</header>
				<div class="w3-container custom_modal_content">
					<table class="patient_data_table" id="SinglePatientDataTable">
						<tr>
							<th>Parameters</th>
							<th>Value</th>
						</tr>
						<tr class="not_header">
							<td>Infusion Rate</td>
							<td ><label id="SinglePatient_IfsRt" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Vd (L)</td>
							<td ><label id="SinglePatient_Vd" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Cl (mL/min)</td>
							<td ><label id="SinglePatient_Cl" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Half-life (hr)</td>
							<td ><label id="SinglePatient_THalf" >test_value_1</label></td>
						</tr>
						<tr>
							<td>Ka (/hr)</td>
							<td ><label id="SinglePatient_Ka" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_max</td>
							<td ><label id="SinglePatient_CMax" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_min</td>
							<td ><label id="SinglePatient_CMin" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_average</td>
							<td ><label id="SinglePatient_CAve" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>AUC24 (mgh/L)</td>
							<td ><label id="SinglePatient_AUC24" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>AUC24 / MIC</td>
							<td ><label id="SinglePatient_AUC24_MIC" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Time to reach steady state (hr)</td>
							<td ><label id="SinglePatient_SteadyT" >test_value_1</label></td>
						</tr>
					</table>      
				</div>
				<footer class="w3-container custom_modal_footer">
					<p class="modal_footer custom_modal_footer_text">&copy; pharmacologytutorials.com</p>
				</footer>
			</div>
		</div>
		<div id="PopulationModal" class="w3-modal w3-animate-opacity">
			<div class="w3-modal-content w3-card-4">
				<header class="w3-container custom_modal_header">
					<span class="w3-button w3-large w3-display-topright close" id="close_all_pop">&times;</span>
					<h5 class="custom_modal_header_text">All Population Average Data</h5>
				</header>
				<div class="w3-container custom_modal_content">
					<table class="patient_data_table" id="AllPopulationDataTable">
						<tr>
							<th>Parameters</th>
							<th>Value</th>
						</tr>
						<tr class="not_header">
							<td>Infusion Rate</td>
							<td ><label id="AllPatient_IfsRt" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Vd (L)</td>
							<td ><label id="AllPatient_Vd" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Cl (mL/min)</td>
							<td ><label id="AllPatient_Cl" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Half-life (hr)</td>
							<td ><label id="AllPatient_THalf" >test_value_1</label></td>
						</tr>
						<tr>
							<td>Ka (/hr)</td>
							<td ><label id="AllPatient_Ka" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_max</td>
							<td ><label id="AllPatient_CMax" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_min</td>
							<td ><label id="AllPatient_CMin" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>C_average</td>
							<td ><label id="AllPatient_CAve" >N.A.</label></td>
						</tr>
						<tr class="not_header">
							<td>AUC24 (mgh/L)</td>
							<td ><label id="AllPatient_AUC24" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>AUC24 / MIC</td>
							<td ><label id="AllPatient_AUC24_MIC" >test_value_1</label></td>
						</tr>
						<tr class="not_header">
							<td>Time to reach steady state (hr)</td>
							<td ><label id="AllPatient_SteadyT" >test_value_1</label></td>
						</tr>
					</table>      
				</div>
				<footer class="w3-container custom_modal_footer">
					<p class="modal_footer custom_modal_footer_texts">&copy; pharmacologytutorials.com</p>
				</footer>
			</div>
		</div>
		
		<script>	
//Global parameters defined here
var BodyWeight = 65;
var VolumnDistribution = {mean: 1.1, std: 0.4};
var Tau = 8;
var Infusion = 2;
var Dose = 500;
var Clearance = {mean: 100, std: 16};
var MIC = 1;
var hMax = 60;
var vMax = 0;
var onePopulation = true;
var firstPopulation = true;
var DefaultPatient, DefaultTau, DefaultDose, ActivePatient, Washout;

//Calculation parameters defined here
var clearance, actualKe;
var _K0, _Ke, _Vd;
var _First20Patients = {};

//Message repository variables
var messageRepository = {
    SwitchPatient: "switch patient",
    ChangePopulation: "change population",
    ShowPatientData: "show patient data",
    BackToFirstPatient: "back to first patient",
    Yes: "yes button clicked",
    FrequencySelection: "selected new frequency",
    DosageInput: "user input new new dosage",
    OptimizeCondition: "apply changes to dosage and frequency"
}

//Page Logic define here
$(document).ready(function () {							
    window.addEventListener("message", ReceiveMessage, false);
    Washout = Tau - Infusion;
    ActivePatient = Math.floor(Math.random() * 20);
    EmptyParameters();
    First20Patients();
    SaveDefault();
    google.charts.load('current', {'packages':['line', 'corechart']});
    google.charts.setOnLoadCallback(SetGraphData);
    SetGraphData();
});

document.getElementById("close_single").addEventListener("click", function() {
    $("#SinglePatientData")[0].classList.add('w3-animate-show');
});
document.getElementById("close_all_pop").addEventListener("click", function() {
    $("#PopulationModal")[0].classList.add('w3-animate-show');
});
document.getElementById("SinglePatientData").addEventListener('animationend', function() {
      if (this.classList.contains('w3-animate-show')) {
            this.style.display = 'none';
            this.classList.remove('w3-animate-show')
      }
});
document.getElementById("PopulationModal").addEventListener('animationend', function() {
      if (this.classList.contains('w3-animate-show')) {
            this.style.display = 'none';
            this.classList.remove('w3-animate-show')
      }
});

//Behavior function define below
function ReceiveMessage(e) {
    if (e.data.Message == undefined) 
    {
        alert("Unrecognized message received.");
        return;
    }

    switch(e.data.Message)
    {
        case messageRepository.SwitchPatient: SwitchPatient(); break;
        case messageRepository.ChangePopulation: ChangePopulation(); break;
        case messageRepository.ShowPatientData: ShowPatientData(); break;
        case messageRepository.BackToFirstPatient: GoBackDefault(); break;
        case messageRepository.Yes: YesOnClick(); break;
        case messageRepository.OptimizeCondition: 
            var freq = e.data.Frequency;
            var dose = e.data.Dosage;
            if (freq == undefined || dose == undefined) 
            {
                alert("Incomplete input parameters!");
                return;
            }
            OptimizeCondition(dose, freq);
            break;
        default: alert("Invalid message posted!"); break;
    }
}

function YesOnClick() {
    onePopulation = !onePopulation;
    SetGraphData();
}

function OptimizeCondition (dose, freq) {
    RetrieveDefault();
    Dose = parseInt(dose);
    if (isNaN(Dose)) 
    {
        alert("Invalid dosage input!");
        return;
    }
    for(var i = 0; i < 20; i++)
    {
        _K0[i] = Dose;
    }
    Tau = parseInt(freq);
    Washout = Tau - Infusion;
    onePopulation = true;
    SetGraphData();
}

function SwitchPatient () {
    if (!firstPopulation) return;
    ActivePatient++;
    ActivePatient %= 20;
    SetGraphData();					
}

function ShowPatientData () {
    var target = onePopulation? $("#SinglePatientData") : $("#PopulationModal");
    target.css("display", "block");
}

function GoBackDefault () {
    RetrieveDefault();
    firstPopulation = true;
    SetGraphData();
}	

function ChangePopulation () {
    firstPopulation = false;
    First20Patients();	
    SetGraphData();
}

function SaveDefault () {
    _First20Patients["clearance"] = clearance.slice();
    _First20Patients["actualKe"] = actualKe.slice();
    _First20Patients["_K0"] = _K0.slice();
    _First20Patients["_Ke"] = _Ke.slice();
    _First20Patients["_Vd"] = _Vd.slice();
    DefaultPatient = ActivePatient;
    DefaultDose = Dose;
    DefaultTau = Tau;
}

function RetrieveDefault () {
    EmptyParameters();
    clearance = _First20Patients.clearance.slice();
    actualKe = _First20Patients.actualKe.slice();
    _K0 = _First20Patients._K0.slice();
    _Ke = _First20Patients._Ke.slice();
    _Vd = _First20Patients._Vd.slice();
    ActivePatient = DefaultPatient;
    Dose = DefaultDose;
    Tau = DefaultTau;
}

//Calculation function define below		
function CalculateMean(m, s){
    var a1 = m * m;
    var a2 = Math.sqrt(m * m + s * s);
    return Math.log(a1/a2);
}
function CalculateStd(m, s){
    var a1 = m * m;
    var a2 = a1 + s * s;
    return Math.sqrt(Math.log(a2/a1));
}

function EmptyParameters() {
    _K0 = [];
    _Vd = [];
    clearance = [];
    actualKe = [];
    _Ke = [];
}

function PrepareParameters() {								
    _K0.push(Dose);
    _Vd.push(jStat.lognormal.inv(Math.random(), 
                              CalculateMean( VolumnDistribution.mean, VolumnDistribution.std),
                              CalculateStd( VolumnDistribution.mean, VolumnDistribution.std)) * BodyWeight);
                              
    clearance.push(jStat.lognormal.inv(Math.random(), 
                                    CalculateMean(Clearance.mean, Clearance.std),
                                    CalculateStd(Clearance.mean, Clearance.std)));
                                    
    actualKe.push(Math.min(0.9999, (clearance[clearance.length - 1]*60)/(_Vd[_Vd.length - 1]*1000)));
    _Ke.push(Math.log(1) - Math.log(1 - actualKe[actualKe.length - 1]));
}

function First20Patients() {
    EmptyParameters();
    for(var i = 0; i < 20; i++)
        PrepareParameters();
}

function SetGraphData() {
    var data;
    if (onePopulation)
    {
        data = OnePopulation();
    }
    else
    {
        data = AllPopulation();
    }
    DrawGraph(data);
}

function f1(t, i){
    var a1 = _K0[i];
    var a2 = _Ke[i] * _Vd[i];
    var a3 = 1 - Math.exp(-_Ke[i]*Infusion);
    var a4 = Math.exp(-_Ke[i]*(t-Infusion));
    return a1*a3*a4/a2;
}

function f2(t,i) {
    var a1 = _K0[i];
    var a2 = _Ke[i] * _Vd[i];
    var a3 = 1 - Math.exp(-_Ke[i]*t);
    return a1*a3/a2;
}

function CalculateAmount(t, i) {
    return t > Infusion? f1(t, i):f2(t, i);
}

function AmountAtTime(t, i) {
    if (t < Tau)
        return CalculateAmount(t, i);
    else
        return AmountAtTime(t - Tau, i) + CalculateAmount(t, i);
}

function Round2Decimal(val) {
    return Math.round(val*100)/100;
}

function OnePopulation() {
    var cmin = 1000000, cmax = 0, cave = 0, auc = 0;
    var dataArray = new Array();
    var t = 0;
    while (t < 60)
    {
        var a = AmountAtTime(t, ActivePatient);
        dataArray.push([t, a]);
        t += 0.25;
        if (a > vMax) vMax = a;
        if (t >= 60 - Tau) 
        {	
            cave += a/24;
            if (a > cmax) cmax = a;
            if (a < cmin) cmin = a;
        }
    }					
    
    $("#SinglePatient_IfsRt").text(Round2Decimal(Dose).toString());
    $("#SinglePatient_Vd").text(Round2Decimal(_Vd[ActivePatient]).toString());
    $("#SinglePatient_Cl").text(Round2Decimal(clearance[ActivePatient]).toString());
    $("#SinglePatient_THalf").text(Round2Decimal((Math.log(2)/_Ke[ActivePatient])).toString());
    $("#SinglePatient_Ka").text(Round2Decimal(actualKe[ActivePatient]).toString());
    $("#SinglePatient_CMin").text(Round2Decimal(cmin).toString());
    $("#SinglePatient_CMax").text(Round2Decimal(cmax).toString());
    $("#SinglePatient_CAve").text(Round2Decimal(cave).toString());
    $("#SinglePatient_AUC24").text(Round2Decimal(auc).toString());
    $("#SinglePatient_AUC24_MIC").text(Round2Decimal(auc/MIC).toString());
    $("#SinglePatient_SteadyT").text(Round2Decimal((Math.log(2)/_Ke[ActivePatient])*4.5).toString());
    
    vMax = Math.round(vMax*10)/10;
    return dataArray;
}

function AllPopulation() {					
    var population = new Array(240);
    var vd = 0, cl = 0, thalf = 0, ke = 0, cmin = 1000000, cmax = 0, auc = 0;
    
    for(var i = 0; i < 240; i++)
    {
        population[i] = new Array(22);
        population[i][21] = 0;
    }
    for(var j = 0; j < 21; j++)
    {	
        var local_max = 0; 
        vd += (_Vd[j%20]/20)*(j<20);
        cl += clearance[j%20]/20*(j<20);
        thalf += Math.log(2)/_Ke[j%20]/20*(j<20);
        ke += actualKe[j%20]/20*(j<20);
        for(var i = 0; i < 240; i++)
        {
            var t = i * 0.25;
            if (j == 0) {
                population[i][j] = t;
            }
            else {
                population[i][j] = AmountAtTime(t,j-1);
                if (population[i][j] > vMax) vMax = population[i][j];
                if (population[i][j] > local_max) local_max = population[i][j];
                population[i][21] += population[i][j]/20;
            }
        }
        
        if (j == 0) continue;
        if (local_max < cmin && i >= 240 - Tau*4) cmin = local_max;
        if (local_max > cmax && i >= 240 - Tau*4) cmax = local_max;
    }
    
    for(var i = 240 - 24*4; i < 240; i++) auc += population[i][21];
    
    $("#AllPatient_IfsRt").text(Round2Decimal(Dose).toString());
    $("#AllPatient_Vd").text(Round2Decimal(vd).toString());
    $("#AllPatient_Cl").text(Round2Decimal(cl).toString());
    $("#AllPatient_Ka").text(Round2Decimal(ke).toString());
    $("#AllPatient_THalf").text(Round2Decimal(thalf).toString());
    $("#AllPatient_CMin").text(Round2Decimal(cmin).toString());
    $("#AllPatient_CMax").text(Round2Decimal(cmax).toString());
    $("#AllPatient_AUC24").text(Round2Decimal(auc).toString());
    $("#AllPatient_AUC24_MIC").text(Round2Decimal(auc/MIC).toString());
    $("#AllPatient_SteadyT").text(Round2Decimal(thalf*4.5).toString());
    
    vMax = Math.round(vMax*10)/10;
    return population;
}

function DrawGraph(data) {
    var chart_styling = 
    chart_styling = 
    {
        title: "Vancomycin Multiple Infusion",
        legend: {
            textStyle: {
                color: "#14b4e0",
                fontSize: 12,
                bold: true
            }
        },
        hAxis: {
            title: "Hours",
            gridlines: {
                color: "#3a3a3a"
            },
            textStyle: {
                color: '#14b4e0',
                fontSize: 16,
                fontName: 'Arial',
                bold: true,
                italic: true
            },
            titleTextStyle: {
                color: '#14b4e0',
                fontSize: 16,
                fontName: 'Arial',
                bold: false,
                italic: true
            },
            ticks:[0, 15, 30, 45, 60]
        },
        vAxis: {
            title: "Antibiotic Concentration (mg/L)",
            gridlines: {
                color: "#3a3a3a"
            },
            textStyle: {
                color: '#14b4e0',
                fontSize: 16,
                fontName: 'Arial',
                bold: true,
                italic: true
            },
            titleTextStyle: {
                color: '#14b4e0',
                fontSize: 16,
                fontName: 'Arial',
                bold: false,
                italic: true
            },
            ticks: [20, 40, 60, 80, 100]
        },
        chartArea: {
            top: 30,
            left: 80,
            width: '76%',
            height: '80%'
        },
        width: 890,
        height: 500,
        backgroundColor: '#000000',
        series: {}
    }
    var table = new google.visualization.DataTable();
    table.addColumn("number", "Time");
    if (onePopulation) {
        table.addColumn("number", "Patient-"+(ActivePatient+1).toString());
        chart_styling.series = {
            0: {color: '#00FF00'}
        }
    }
    else {
        for (var i = 1; i <= 20; i++)
        {
            table.addColumn("number", "Patient-"+i);
            if (!firstPopulation || i != ActivePatient+1) 
                chart_styling.series[i-1] = {
                    lineWidth: 1,
                    lineDashStyle: [4, 4],
                    color: "#1EB1EE",
                    visibleInLegend: false
                };
            else
                chart_styling.series[i-1] = {
                    lineWidth: 3,
                    color: "#00FF00",
                    visibleInLegend: true
                };
        }
        table.addColumn("number", "Average");
        chart_styling.series["20"] = {
            lineWidth: 3,
            color: "#FF0000",
            visibleInLegend: true
        }
    }
    table.addRows(data);
    var chart = new google.visualization.LineChart(document.getElementById("ChartArea"));
    chart.draw(table, chart_styling);
}
		</script>
	</body>
</html>