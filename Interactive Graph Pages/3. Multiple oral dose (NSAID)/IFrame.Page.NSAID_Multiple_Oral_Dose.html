<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
		<script	src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
			  integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
			  crossorigin="anonymous"/>
		<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css"/>
		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
		<script type="text/javascript" src="http://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jstat/1.7.1/jstat.js"></script>
		<script type="text/javascript" src="http://requirejs.org/docs/release/2.2.0/minified/require.js"></script>	
		
		<link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" 
			  rel="stylesheet" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" 
			  crossorigin="anonymous">
		<link href="Backend/CommonStyle.css" rel="stylesheet">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
		<script src="https://code.jquery.com/jquery-3.3.1.min.js"
				integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
				crossorigin="anonymous"></script>
		<style>
			body {
    overflow: hidden;
    font-family: tahoma;
    font-weight: normal;
    background: #6ea4ca;
}

.container{
    margin-left: 10px;
    margin-top: 20px;
}
.chart-area{
    position: relative;
}

.modal {
    display: none;
    position: fixed;
    z-index: 1; 
    padding-top: 100px;
    left: 0;
    top: 0;
    width: 100%; 
    height: 100%; 
    overflow: auto; 
    background-color: rgb(0,0,0);
    background-color: rgba(0,0,0,0.4);
}

.custom_modal_header {
    height: 38px;
    background-color: #0c3c60;
    color: #fff!important;
}

.custom_modal_header_text {
    margin-top: 8px;
}

.custom_modal_content {
    margin-top: 10px;
    margin-bottom: 10px;
}

.custom_modal_footer {
    height: 30px;
    background-color: #0c3c60;
    color: #fff!important;
}

.custom_modal_footer_text {
    font-size: 13px;
    margin-top: 4px;
}

.w3-animate-opacity {
    animation: opac 0.8s;
}
    
@keyframes opac {
    0% {opacity: 0;}
    100% {opacity: 1;}
}
    
.w3-animate-show {
    animation: show 0.8s;
    animation-fill-mode: forwards;
}
    
@keyframes show {
    0% {opacity: 1;}
    100% {opacity: 0;}
}

.patient_data_table{
    width: 100%;
    margin-top: 10px;
    margin-right: 10px;
}

.patient_data_table tr:nth-child(1) {
    font-size: 14px;
    border-bottom: 2px solid #000000;
}	

.patient_data_table tr {
    font-size: 12px;
    border-bottom: 1px solid #000000;
}

.patient_data_table tr.not_header:hover {
    background: #dbddff;
}

.patient_data_table td label {
    display: inherit;
}

.patient_data_col {
    margin-right: 120px;
}

.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 20px;
    border: 1px solid #888;
    width: 80%;	
}

.watermark {
    color: #d0d0d0;
    font-size: 0.85em;
    position: relative;
    margin-top: -25px;
}

.table_title {
    font-size: 18px;
    font-family: Arial;
    font-weight: bold;
}
		</style>
		<title></title>
	</head>
	<body>
		<div class="row container" id="GraphContainer">
			<div class="col-lg-12">
				<h6> <br /></h6>
				<h6> <br /></h6>
				<div class="chart-area" style="position:relative" id="ChartArea">
					<div>
						<p class="watermark">	&copy; pharmacologytutorials.com</p>
					</div>
				</div>
			</div>
		</div>
		<!--Modal Area-->
		<div id="SinglePatientData" class="w3-modal w3-animate-opacity">
				<div class="w3-modal-content w3-card-4">
					<header class="w3-container custom_modal_header">
						<span class="w3-button w3-middle w3-display-topright close" id="close_single">&times;</span>
						<h5 class="custom_modal_header_text">Single Patient Data</h5>
					</header>
					<div class="w3-container custom_modal_content">
						<table class="patient_data_table" id="SinglePatientDataTable">
							<tr>
								<th>Parameters</th>
								<th>Value</th>
							</tr>
							<tr class="not_header">
								<td>Vd (L)</td>
								<td ><label id="SinglePatient_Vd" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>Cl (mL/min)</td>
								<td ><label id="SinglePatient_Cl" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>Half-life (hr)</td>
								<td ><label id="SinglePatient_THalf" >test_value_1</label></td>
							</tr>
							<tr>
								<td>Ka (/hr)</td>
								<td ><label id="SinglePatient_Ka" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>C_max</td>
								<td ><label id="SinglePatient_CMax" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>C_min</td>
								<td ><label id="SinglePatient_CMin" >test_value_1</label></td>
							</tr>
						</table>      
					</div>
					<footer class="w3-container custom_modal_footer">
						<p class="modal_footer custom_modal_footer_text">&copy; pharmacologytutorials.com</p>
					</footer>
				</div>
		</div>
		<div id="PopulationModal" class="w3-modal w3-animate-opacity">
				<div class="w3-modal-content w3-card-4">
					<header class="w3-container custom_modal_header">
						<span class="w3-button w3-large w3-display-topright close" id="close_all_pop">&times;</span>
						<h5 class="custom_modal_header_text">All Population Average Data</h5>
					</header>
					<div class="w3-container custom_modal_content">
						<table class="patient_data_table" id="AllPopulationDataTable">
							<tr>
								<th>Parameters</th>
								<th>Value</th>
							</tr>
							<tr class="not_header">
								<td>Vd (L)</td>
								<td ><label id="AllPatient_Vd" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>Cl (mL/min)</td>
								<td ><label id="AllPatient_Cl" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>Half-life (hr)</td>
								<td ><label id="AllPatient_THalf" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>Ka (/hr)</td>
								<td ><label id="AllPatient_Ka" >test_value_1</label></td>
							</tr>
							<tr class="not_header">
								<td>C_max</td>
								<td ><label id="AllPatient_CMax"> test_value_1</label></td>
							</tr>
							<tr class="not_header"> 
								<td>C_min</td>
								<td ><label id="AllPatient_CMin" >test_value_1</label></td>
							</tr>
						</table>      
					</div>
					<footer class="w3-container custom_modal_footer">
						<p class="modal_footer custom_modal_footer_texts">&copy; pharmacologytutorials.com</p>
					</footer>
				</div>
		</div>
		<script>	
				//Global parameters defined here
				var Gender = "Male";
				var Race = "Chinese";
				var Age = 30;
				var BodyWeight = 65;
				var Height = 1.8;
				var Dose = 100;
				var Tau = 24;
				var VolumnDistribution = {mean: 25, std: 5};
				var ExtractionRate = {mean: 0.1, std: 0.02};
				var Ka = {mean: 2, std: 0.4};
				var Clearance = {mean: 240, std: 48};
				var hMax = 200;
				var vMax = 0;
				var clearance, actualKe;
				
				//Calculation parameters defined here
				var _F, _D, _Ka, _Ke, _Vd;
				
				$(document).ready(function () {
					RestoreDefault();
					PrepareParameters();
					google.charts.load('current', {'packages':['line', 'corechart']});
					google.charts.setOnLoadCallback(SetGraphData);
					
					$("#ChangeSample").hide();
					
				});
				
				$("#AllPopulation").on("click", function () {
					if ($(this).text() == "Yes")
					{
						$(this).text("No");
						$("#ShowPatientData").attr("all-population", "true");
						$("#AllPopulationData").show();
						$("#ChangeSample").show();
					}
					else
					{
						$(this).text("Yes");
						$("#ShowPatientData").attr("all-population", "false");
						$("#AllPopulationData").hide();
						$("#ChangeSample").hide();
					}
					
					UpdateParameters();
					PrepareParameters();
					SetGraphData();
				});
				
				$("#ChangeSample").on("click", OnePopulation);
				
				$("#ShowPatientData").on("click", function () {
					if ($(this).text().trim() == "Show Patient Data") 
					{
						$("#PatientData").show();
						$(this).text("Hide Patient Data");
					}
					else 
					{
						$("#PatientData").hide();
						$(this).text("Show Patient Data");
					}
				});
				
				$("#ChangePopulation").on("click", function() {
					UpdateParameters();
					PrepareParameters();
					SetGraphData();
				});

				$("#ResetButton").on("click", function() {
					RestoreDefault();
				})

				$(document).find("input").each(function () {
					$(this).on("change", function() {
						if (parseFloat($(this).val()) === NaN)
						{
							alert("Invalid input parameters, must be a number!");
							$(this).val("");
						}
					});
				});

				//Behavioural functions define below
				function RestoreDefault(){
					$(document).find("input").each(function() {
						if($(this).attr("default-value") != undefined)
						{
							$(this).val($(this).attr("default-value"));
						}
					});
				}

				function UpdateParameters(){
					Age = $("#AgeValue").val();
					BodyWeight = $("#BWValue").val();
					Height = $("#HeightValue").val();
					Dose = $("#DoseValue").val();
					Tau = $("#TauValue").val();
					VolumnDistribution.mean = $("#VdMeanValue").val();
					VolumnDistribution.std = $("#VdStdValue").val();
					ExtractionRate.mean = $("#ERMeanValue").val();
					ExtractionRate.std = $("#ERStdValue").val();
					Ka.mean = $("#KaMeanValue").val();
					Ka.std = $("#KaStdValue").val();
					Clearance.mean = $("#CLMeanValue").val();
					Clearance.std = $("#CLStdValue").val();
				}

				//Calculation function define below		
				function CalculateMean(m, s)
				{
					var a1 = m * m;
					var a2 = Math.sqrt(m * m + s * s);
					return Math.log(a1/a2);
				}

				function CalculateStd(m, s)
				{
					var a1 = m * m;
					var a2 = a1 + s * s;
					return Math.sqrt(Math.log(a2/a1));
				}

				function PrepareParameters() {
					vMax = 0;
					var f = jStat.lognormal.inv(Math.random(), 
												CalculateMean(ExtractionRate.mean, ExtractionRate.std),
												CalculateStd(ExtractionRate.mean, ExtractionRate.std));
					_F = 1 - f;
					_D = Dose;
					_Ka = jStat.lognormal.inv(Math.random(), 
											  CalculateMean(Ka.mean, Ka.std),
											  CalculateStd(Ka.mean, Ka.std));
					_Vd = _F * jStat.lognormal.inv(Math.random(), 
												   CalculateMean(VolumnDistribution.mean, VolumnDistribution.std),
												   CalculateStd(VolumnDistribution.mean, VolumnDistribution.std));
					clearance = jStat.lognormal.inv(Math.random(), 
														CalculateMean(Clearance.mean, Clearance.std),
														CalculateStd(Clearance.mean, Clearance.std)) * _F;
					actualKe = Math.min((clearance*60)/(_Vd*1000), 0.9999);
					_Ke = Math.log(1) - Math.log(1-actualKe);
				}
				
				function CalculateAmount(t) {
					var a1 = _F * _D * _Ka;
					var a2 = _Vd * (_Ka - _Ke);
					var a3 = Math.exp(-_Ke*t) - Math.exp(-_Ka*t);
					return a1*a3/a2;
				}

				function AmountAtTime(t) {
					if (t < Tau)
						return CalculateAmount(t);
					else
						return AmountAtTime(t - Tau) + CalculateAmount(t);
				}
				
				function Round2Decimal(val) {
					return Math.round(val*100)/100;
				}

				function OnePopulation() {
					PrepareParameters();
					var dataArray = new Array();
					var t = 0;
					while (t <= 200)
					{
						var a = AmountAtTime(t)
						dataArray.push([t, a]);
						t += 0.25;

						if (a > vMax) vMax = a;
					}
					
					$("#SinglePatient_Vd").text(Round2Decimal(_Vd).toString());
					$("#SinglePatient_Cl").text(Round2Decimal(clearance).toString());
					$("#SinglePatient_THalf").text(Round2Decimal((Math.log(2)/_Ke)).toString());
					$("#SinglePatient_Ka").text(Round2Decimal(actualKe).toString());
					$("#SinglePatient_CMin").text("0.00");
					$("#SinglePatient_CMax").text(Round2Decimal(vMax).toString());
					
					vMax = Math.round(vMax*10)/10;
					return dataArray;
				}

				function AllPopulation() {
					OnePopulation();							
					var population = new Array(800);
					var vd = 0, cl = 0, thalf = 0, ke = 0, cmin = 1000000, cmax = 0;
					
					for(var i = 0; i < 800; i++)
					{
						population[i] = new Array(22);
						population[i][21] = 0;
					}

					for(var j = 0; j < 21; j++)
					{	
						PrepareParameters();
						var local_max = 0; 
						vd += _Vd/20;
						cl += clearance/20;
						thalf += Math.log(2)/_Ke/20;
						ke += actualKe/20;
						for(var i = 0; i < 800; i++)
						{
							var t = i * 0.25;
							if (j == 0) {
								population[i][j] = t;
							}
							else {
								population[i][j] = AmountAtTime(t);
								if (population[i][j] > vMax) vMax = population[i][j];
								if (population[i][j] > local_max) local_max = population[i][j];
								population[i][21] += population[i][j]/20;
							}
						}
						
						if (j == 0) continue;
						if (local_max < cmin) cmin = local_max;
						if (local_max > cmax) cmax = local_max;
					}

					$("#AllPatient_Vd").text(Round2Decimal(vd).toString());
					$("#AllPatient_Cl").text(Round2Decimal(cl).toString());
					$("#AllPatient_Ka").text(Round2Decimal(ke).toString());
					$("#AllPatient_THalf").text(Round2Decimal(thalf).toString());
					$("#AllPatient_CMin").text(Round2Decimal(cmin).toString());
					$("#AllPatient_CMax").text(Round2Decimal(cmax).toString());
					
					vMax = Math.round(vMax*10)/10;
					return population;
				}

				function SetGraphData() {
					var data;
					if ($("#ShowPatientData").attr("all-population") == "false")
					{
						data = OnePopulation();
					}
					else
					{
						data = AllPopulation();
					}

					DrawGraph(data);
				}

				function DrawGraph(data) {
					var chart_styling = 
					chart_styling = 
					{
						title: "NSAID Multiple Oral Dose",
						legend: 'none',
						hAxis: {
							title: "Hours",
							textStyle: {
								color: '#01579b',
								fontSize: 16,
								fontName: 'Arial',
								bold: true,
								italic: true
							},
							titleTextStyle: {
								color: '#01579b',
								fontSize: 16,
								fontName: 'Arial',
								bold: false,
								italic: true
							},
							ticks:[0, 50, 100, 150, 200]
						},
						vAxis: {
							title: "Plasma Conc (mg/L)",
							textStyle: {
								color: '#01579b',
								fontSize: 16,
								fontName: 'Arial',
								bold: true,
								italic: true
							},
							titleTextStyle: {
								color: '#01579b',
								fontSize: 16,
								fontName: 'Arial',
								bold: false,
								italic: true
							},
							ticks: [vMax*0.6, vMax*1.2, vMax*1.8, vMax*2.4, vMax*3.0]
						},
						chartArea: {
							top: 30
						},
						width: 630,
						height: 470,
						backgroundColor: '#f1f8e9',
						series: {}
					}

					var table = new google.visualization.DataTable();
					table.addColumn("number", "Time");
					if ($("#ShowPatientData").attr("all-population") == "false") {
						table.addColumn("number", "Concentration");
					}
					else {
						for (var i = 1; i <= 20; i++)
						{
							table.addColumn("number", "Population-"+i);
							chart_styling.series[i-1] = {
								lineWidth: 1,
								lineDashStyle: [4, 4],
								color: "#1EB1EE"
							}
						}
						table.addColumn("number", "Average");
						chart_styling.series["20"] = {
							lineWidth: 3,
							color: "#FF0000"
						}
					}
					table.addRows(data);

					var chart = new google.visualization.LineChart(document.getElementById("ChartArea"));
					chart.draw(table, chart_styling);
				}
		</script>
	</body>
</html>